# Copyright (C) 2024 BEARTELL
# Copyright (C) 2017-2019 Dremio Corporation
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

#
# Environment Variables:
#
#   JAVA_HOME                  The java implementation to use.
#
#   IGLO_CLASSPATH            Extra Java CLASSPATH entries.
#
#   IGLO_CLASSPATH_PREFIX     Extra Java CLASSPATH entries that should
#                               be prefixed to the system classpath.
#
#   HADOOP_HOME                 Hadoop home
#
#   HBASE_HOME                  HBase home

# resolve links - "${BASH_SOURCE-$0}" may be a softlink
this="${BASH_SOURCE-$0}"
while [ -h "$this" ]; do
  ls=`ls -ld "$this"`
  link=`expr "$ls" : '.*-> \(.*\)$'`
  if expr "$link" : '.*/.*' > /dev/null; then
    this="$link"
  else
    this=`dirname "$this"`/"$link"
  fi
done

# convert relative path to absolute path
bin=`dirname "$this"`
script=`basename "$this"`
home=`cd "$bin/..">/dev/null; pwd`
this="$home/bin/$script"

# the root of the Iglo installation
if [ -z "$IGLO_HOME" ]; then
  IGLO_HOME="$home"
fi

#check to see if the conf dir or Iglo home are given as an optional arguments
while [ $# -gt 1 ]; do
  if [ "--config" = "$1" ]; then
    shift
    confdir=$1
    shift
    IGLO_CONF_DIR=$confdir
  else
    # Presume we are at end of options and break
    break
  fi
done

if [ -z "$IGLO_CONF_DIR" ]; then
  # Defaults to local configuration if configuration is not set
  IGLO_CONF_DIR="${IGLO_HOME}/conf"
elif [ ! -d "${IGLO_CONF_DIR}" -o ! -x "${IGLO_CONF_DIR}" ]; then
  echo "Iglo conf directory $IGLO_CONF_DIR does not exist, is not a directory or is not accessible."
  exit 1
fi

# Source ${IGLO_ENV_SCRIPT} for any user configured values
if [ -f "${IGLO_CONF_DIR}/${IGLO_ENV_SCRIPT}" ]; then
  . "${IGLO_CONF_DIR}/${IGLO_ENV_SCRIPT}"
fi

# get log directory
IGLO_LOG_DIR="${IGLO_LOG_DIR:-${IGLO_HOME}/log}"

# get plugins root directory
IGLO_PLUGINS_DIR="${IGLO_PLUGINS_DIR:-${IGLO_HOME}/plugins}"

touch "$IGLO_LOG_DIR/server.out" &> /dev/null
TOUCH_EXIT_CODE=$?
if [ "$TOUCH_EXIT_CODE" = "0" ]; then
  if [ "x$IGLO_LOG_DEBUG" = "x1" ]; then
    echo "Iglo log directory: $IGLO_LOG_DIR"
  fi
  IGLO_LOG_DIR_FALLBACK=0
else
  #Force IGLO_LOG_DIR to fall back
  IGLO_LOG_DIR_FALLBACK=1
fi

if [ ! -d "$IGLO_LOG_DIR" ] || [ "$IGLO_LOG_DIR_FALLBACK" = "1" ]; then
  if [ "x$IGLO_LOG_DEBUG" = "x1" ]; then
    echo "Iglo log directory $IGLO_LOG_DIR does not exist or is not writable, defaulting to $IGLO_HOME/log"
  fi
  IGLO_LOG_DIR="$IGLO_HOME/log"
fi

# Add Iglo conf folder at the beginning of the classpath
IGLO_CLASSPATH="$IGLO_CONF_DIR"

# Followed by any user specified override jars
if [ "${IGLO_CLASSPATH_USER_FIRST}x" != "x" ]; then
  IGLO_CLASSPATH="$IGLO_CLASSPATH:$IGLO_CLASSPATH_USER_FIRST"
fi

# Next Iglo core jars
IGLO_CLASSPATH="$IGLO_CLASSPATH:$IGLO_HOME/jars/*"

# Followed by Iglo override dependency jars
IGLO_CLASSPATH="$IGLO_CLASSPATH:$IGLO_HOME/jars/ext/*"

# Followed by Hadoop's jar
if [ "${HADOOP_CLASSPATH}x" != "x" ]; then
  IGLO_CLASSPATH="$IGLO_CLASSPATH:$HADOOP_CLASSPATH"
fi

# Followed by HBase' jar
if [ "${HBASE_CLASSPATH}x" != "x" ]; then
  IGLO_CLASSPATH="$IGLO_CLASSPATH:$HBASE_CLASSPATH"
fi

# Followed by Iglo other dependency jars
# Make sure * is not expended by shell
IGLO_CLASSPATH="$IGLO_CLASSPATH:$IGLO_HOME/jars/3rdparty/*"

# Finally any user specified
if [ "${IGLO_EXTRA_CLASSPATH}x" != "x" ]; then
  IGLO_CLASSPATH="$IGLO_CLASSPATH:$IGLO_EXTRA_CLASSPATH"
fi

#
# Shared java options
#
IGLO_JAVA_OPTS="-Djava.util.logging.config.class=org.slf4j.bridge.SLF4JBridgeHandler"

# Set the default path for native hadoop lib
IGLO_JAVA_OPTS="$IGLO_JAVA_OPTS -Djava.library.path=${IGLO_HOME}/lib"

# Test for cygwin
is_cygwin=false
case "`uname`" in
CYGWIN*) is_cygwin=true;;
esac

# Test for or find JAVA_HOME
if [ -z "$JAVA_HOME" ]; then
  if [ -e "`which java`" ]; then
    SOURCE="`which java`"
    while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
      DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
      SOURCE="$(readlink "$SOURCE")"
      [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
    done
    JAVA_HOME="$( cd -P "$( dirname "$SOURCE" )" && cd .. && pwd )"
  fi
  # if we didn't set it
  if [ -z "$JAVA_HOME" ]; then
    cat 1>&2 <<EOF
+======================================================================+
|      Error: JAVA_HOME is not set and Java could not be found         |
+----------------------------------------------------------------------+
| Iglo requires Java 8 or Java 11.                                   |
+======================================================================+
EOF
    exit 1
  fi
fi

#Add tools.jar to support local-attach mode
if [ -f "$JAVA_HOME/lib/tools.jar" ]; then
  IGLO_CLASSPATH="$IGLO_CLASSPATH:$JAVA_HOME/lib/tools.jar"
fi

# Now, verify that 'java' binary exists and is suitable for Iglo.
if $is_cygwin; then
  JAVA_BIN="java.exe"
else
  JAVA_BIN="java"
fi

if [ -z "$JAVA" ]; then
  JAVA="${JAVA_HOME}/bin/${JAVA_BIN}"
  if [ ! -f "${JAVA}" ]; then
    JAVA=`find -L "$JAVA_HOME" -name "$JAVA_BIN" -type f | head -n 1`
  fi
fi
if [ ! -x "$JAVA" ]; then
  echo "Java not found or Java binary not executable at JAVA_HOME=$JAVA_HOME/JAVA=$JAVA."
  exit 1
fi
# Ensure that Java version is at least 1.8
JAVA_VERSION_STRING=`"$JAVA" -version 2>&1 | sed -n -E 's/(java|openjdk) version "([0-9\\._]+)".*/\2/p'`
JAVA_MAJOR_VERSION=
if `echo $JAVA_VERSION_STRING | egrep -q -e "^1\.[0-9]{1,}\."`; then
    JAVA_MAJOR_VERSION=`echo $JAVA_VERSION_STRING | sed 's/^1\.\([0-9]\{1,\}\)\..*/\1/g'`
elif `echo $JAVA_VERSION_STRING | egrep -q -e "^[0-9]{1,}\."`; then
    JAVA_MAJOR_VERSION=`echo $JAVA_VERSION_STRING | sed 's/^\([0-9]\{1,\}\)\..*/\1/g'`
else
    echo "Cannot parse java version: ${JAVA_VERSION_STRING}"
    exit 1
fi

if [ "$IGLO_JAVA_VERSION_CHECK" == "false" ]; then
  if [ $JAVA_MAJOR_VERSION -lt 8 ]; then
    echo "Java 8 or Java 11 is required to run Iglo."
    exit 1
  fi
elif [ $JAVA_MAJOR_VERSION -ne 8 ] && [ $JAVA_MAJOR_VERSION -ne 11 ]; then
  echo "Java 8 or Java 11 is required to run Iglo. Java $JAVA_MAJOR_VERSION is being used."
  exit 1
fi

# Adjust paths for CYGWIN
if $is_cygwin; then
  IGLO_HOME=`cygpath -w "$IGLO_HOME"`
  IGLO_CONF_DIR=`cygpath -w "$IGLO_CONF_DIR"`
  IGLO_LOG_DIR=`cygpath -w "$IGLO_LOG_DIR"`
  IGLO_CLASSPATH=`cygpath -w -p "$IGLO_CLASSPATH"`
  if [ -z "$HADOOP_HOME" ]; then
    HADOOP_HOME=${IGLO_HOME}/winutils
  fi
fi

export IGLO_HOME # needed for the HOCON commands below

# Set proper memory values based on user configured values
if [[ -n $IGLO_MAX_MEMORY_SIZE_MB ]]
then
  if [ 4096 -gt $IGLO_MAX_MEMORY_SIZE_MB ]; then
    echo "Iglo requires at least 4 GB memory to run. ${IGLO_MAX_MEMORY_SIZE_MB} MB is too low."
    exit 1
  fi
  ROLES=`$JAVA -cp "$IGLO_CLASSPATH" $IGLO_JAVA_EXTRA_OPTS -Ddremio.log.path=${IGLO_LOG_DIR} com.dremio.dac.daemon.GetRolesCommand`
  if ( echo $ROLES | grep -q "executor" ); then
    DEFAULT_MAX_HEAP_MEMORY_EXECUTOR_MB=2048
    if [ 6144 -le $IGLO_MAX_MEMORY_SIZE_MB ]; then
      DEFAULT_MAX_HEAP_MEMORY_EXECUTOR_MB=4096
    fi
    if [ 32768 -le $IGLO_MAX_MEMORY_SIZE_MB ]; then
      DEFAULT_MAX_HEAP_MEMORY_EXECUTOR_MB=8192
    fi
    IGLO_MAX_HEAP_MEMORY_SIZE_MB=${IGLO_MAX_HEAP_MEMORY_SIZE_MB:-$DEFAULT_MAX_HEAP_MEMORY_EXECUTOR_MB}
    IGLO_MAX_DIRECT_MEMORY_SIZE_MB=${IGLO_MAX_DIRECT_MEMORY_SIZE_MB:-$((IGLO_MAX_MEMORY_SIZE_MB-IGLO_MAX_HEAP_MEMORY_SIZE_MB))}
  else
    if [ 18432 -le $IGLO_MAX_MEMORY_SIZE_MB ]; then
      IGLO_MAX_HEAP_MEMORY_SIZE_MB=${IGLO_MAX_HEAP_MEMORY_SIZE_MB:-16384}
      IGLO_MAX_DIRECT_MEMORY_SIZE_MB=${IGLO_MAX_DIRECT_MEMORY_SIZE_MB:-$((IGLO_MAX_MEMORY_SIZE_MB-IGLO_MAX_HEAP_MEMORY_SIZE_MB))}
    else
      IGLO_MAX_DIRECT_MEMORY_SIZE_MB=${IGLO_MAX_DIRECT_MEMORY_SIZE_MB:-2048}
      IGLO_MAX_HEAP_MEMORY_SIZE_MB=${IGLO_MAX_HEAP_MEMORY_SIZE_MB:-$((IGLO_MAX_MEMORY_SIZE_MB-IGLO_MAX_DIRECT_MEMORY_SIZE_MB))}
    fi
  fi
else
  IGLO_MAX_HEAP_MEMORY_SIZE_MB=${IGLO_MAX_HEAP_MEMORY_SIZE_MB:-4096}
  IGLO_MAX_DIRECT_MEMORY_SIZE_MB=${IGLO_MAX_DIRECT_MEMORY_SIZE_MB:-8192}
fi

#Set Timezone as UTC if IGLO_FORCE_UTC is not set
if [ "$IGLO_FORCE_UTC" != "no" ]; then
  export TZ=UTC
fi

print_warn() {
  echo "#######################################################################"
  echo "WARNING:"
  echo ""
  echo "$1"
  echo ""
  echo "#######################################################################"
}

print_error() {
  echo "#######################################################################"
  echo "ERROR:"
  echo ""
  echo "$1"
  echo ""
  echo "#######################################################################"
}

are_gcoptions_conflicting() {
  if [[ "$IGLO_JAVA_SERVER_EXTRA_OPTS $IGLO_JAVA_EXTRA_OPTS" == *"${1}"* ]]; then
    return 1; # false
  fi
  # If *EXTRA_OPTS contains UseGC, then return false to indicate that its not an option to select GC algorithm (like G1GC, ZGC, etc)
  if [[ "$IGLO_JAVA_SERVER_EXTRA_OPTS $IGLO_JAVA_EXTRA_OPTS" == *-XX:+UseGC* ]]; then
      return 1; # false
  fi
  #Since we rule-out *UseGC* in above condition, consider *Use*GC* to contain GC algorithm.
  if [[ "$IGLO_JAVA_SERVER_EXTRA_OPTS $IGLO_JAVA_EXTRA_OPTS" == *-XX:+Use*GC* ]]; then
    return 0; # true
  fi
  return 1; # false
}

check_gc_options_before_start() {
  if [ -z "$IGLO_GC_OPTS" ]; then
    # Case: IGLO_GC_OPTS is not set by user.
    # Make G1GC as default GC. This can be overridden
    # by editing IGLO_GC_OPTS in conf/iglo-env
    IGLO_GC_OPTS="-XX:+UseG1GC"

    # check if above IGLO_GC_OPTS is conflicting with other options
    if are_gcoptions_conflicting $IGLO_GC_OPTS; then

      print_warn "\
The default GC option ($IGLO_GC_OPTS) is conflicting with existing options \
IGLO_JAVA_SERVER_EXTRA_OPTS ($IGLO_JAVA_SERVER_EXTRA_OPTS) and/or \
IGLO_JAVA_EXTRA_OPTS ($IGLO_JAVA_EXTRA_OPTS). \
So the default GC option ($IGLO_GC_OPTS) is not used."

      IGLO_GC_OPTS=""
    fi

  else
    # Case: IGLO_GC_OPTS is set by user
    # check if IGLO_GC_OPTS is conflicting with other options
    if are_gcoptions_conflicting $IGLO_GC_OPTS; then
      print_error "\
The IGLO_GC_OPTS ($IGLO_GC_OPTS) set in iglo-env (or environment variable) \
is conflicting with existing options IGLO_JAVA_SERVER_EXTRA_OPTS ($IGLO_JAVA_SERVER_EXTRA_OPTS) and/or \
IGLO_JAVA_EXTRA_OPTS ($IGLO_JAVA_EXTRA_OPTS). \
Please fix the options to be consistent."

      exit 1;
    fi

  fi
}

startStopStatus=$1
case $startStopStatus in

(start)
  check_gc_options_before_start
  ;;

(start-fg)
  check_gc_options_before_start
  ;;

(*)
  ;;
esac

if [ "$JAVA_MAJOR_VERSION" -ge 9 ]; then
  IGLO_JAVA_OPTS="$IGLO_JAVA_OPTS --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.nio=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED"
fi

# Force -XX:UseAVX=2 on Intel Skylake and Cascade Lake CPUs to improve
# performance.  See https://bugs.openjdk.org/browse/JDK-8286823.
#
# Skylake and Cascade Lake CPUs can be detected by checking for family 6 and
# model=85 in /proc/cpuinfo.
#
# When family is equal to 6, the value of `model` in /proc/cpuinfo is the
# concatenation of the 'Extended Model' (4 leftmost bits) and the CPU 'Model'
# (4 rightmost bits).
#
# - Family=6 and model=85 denotes Cascade Lake and Skylake CPUs (Extended
#   Model=0x5 and Model=0x5)
# - Family=6 and model=106 denotes Ice Lake (Extended Model=0x6 and Model=0xA)
# - ...
#
# Source: https://en.wikichip.org/wiki/intel/cpuid
#
# The code below adds -XX:UseAVX=2 to Iglo Java opts if at *least one* of the
# CPU sockets on the server is running the Skylake or Cascade Lake
# architecture.  I.e. it also works on servers with multiple, heterogeneous
# CPUs.
CPU_VENDOR=$((grep vendor_id /proc/cpuinfo 2>/dev/null || echo '- - None') | sort -u | awk '{print $3}')
IS_CPU_FAMILY_6=$(grep -Eq '^cpu family\s*: 6$' /proc/cpuinfo 2>/dev/null && echo true || echo false)
IS_CPU_SKYLAKE_OR_CASCADELAKE=$(grep -Eq '^model\s*: 85$' /proc/cpuinfo 2>/dev/null && echo true || echo false)
if [ "$JAVA_MAJOR_VERSION" -ge 11 ] && \
   [ "$CPU_VENDOR" = "GenuineIntel" ] && \
   [ "$IS_CPU_FAMILY_6" = "true" ] && \
   [ "$IS_CPU_SKYLAKE_OR_CASCADELAKE" = "true" ]
then
  IGLO_JAVA_OPTS="$IGLO_JAVA_OPTS -XX:UseAVX=2"
fi

# make sure allocator chunks are done as mmap'd memory (and reduce arena overhead)
# Newer versions of glibc use an arena memory allocator that causes virtual
# memory usage to explode. Tune the variable down to prevent vmem explosion.
export MALLOC_ARENA_MAX=${MALLOC_ARENA_MAX:-4}
export MALLOC_MMAP_THRESHOLD_=131072
export MALLOC_TRIM_THRESHOLD_=131072
export MALLOC_TOP_PAD_=131072
export MALLOC_MMAP_MAX_=65536

# Variables exported from this script
export JAVA_VERSION_STRING
export JAVA_MAJOR_VERSION
export HADOOP_HOME
export is_cygwin
export IGLO_JAVA_OPTS
export IGLO_CONF_DIR
export IGLO_LOG_DIR
export IGLO_PLUGINS_DIR
export IGLO_CLASSPATH
export IGLO_MAX_HEAP_MEMORY_SIZE_MB
export IGLO_MAX_DIRECT_MEMORY_SIZE_MB
export IGLO_ADMIN_LOG_DIR
export IGLO_ADMIN_LOG_VERBOSITY
export IGLO_GC_OPTS
export IGLO_DISABLE_HEAPDUMP
